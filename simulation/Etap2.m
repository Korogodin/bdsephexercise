Toe = 237600;
Crs = 1.98671875000000000e+02;
mu = 3.986004418e+14;
dn = 8.62178763712945218e-13;
Cuc = 6.31529837846755981e-06;
e = 5.34449948463588953e-03;
Cus = 8.50530341267585754e-06;
A = 6.49309631156921387e+03^2;
Cic = -6.75208866596221924e-08;
Wo = -1.48546375932237629e+00;
Cis = -1.37835741043090820e-07;
Io = 1.03971822793466973e+00;
Crc = 1.32500000000000000e+01;
Mo = -1.55333764299921384e+00;
We = 7.2921150e-5;
W = -2.69237391183751207e+00;
Wdot = -2.10187326574395889e-12;
idot = 5.20021660989499327e-13;
T = 226800;
wur = 55.45235679;
dl = 37.42120145;
H = 200;
for j=1:43201;
no = sqrt(mu/(A^3));
Tk=T-Toe;
n=no+dn;
M = Mo+n*Tk;
E=0;
for l=1:100;
E=M+e*sin(E);
end
nu = atan2(sqrt(1-e^2)*sin(E),cos(E)-e);
F1 = nu+W;
du = Cus*sin(2*F1)+Cuc*cos(2*F1);
dr = Crs*sin(2*F1)+Crc*cos(2*F1);
di = Cis*sin(2*F1)+Cic*cos(2*F1);
F2 = F1+du;
r = A*(1-e*cos(E))+dr;
i = Io+di+idot*Tk;
poX = r*cos(F2);
poY = r*sin(F2);
Omega = Wo+(Wdot-We)*(Tk)-We*Toe;
x = poX*cos(Omega)-poY*cos(i)*sin(Omega);
y = poX*sin(Omega)+poY*cos(i)*cos(Omega);
z = poY*sin(i); 
Resfix(j,:) = [x y z];
phi = We*Tk; 
xc = x*cos(phi)-y*sin(phi);
yc = x*sin(phi)+y*cos(phi);
zc = z; 
ResECI(j,:)=[xc yc zc]; 
[East, North, Up] = ecef2enu(x, y, z, wur, dl,H, wgs84Ellipsoid);
R = sqrt(East^2 + North^2 + Up^2);
el(j) = rad2deg(-asin(Up/R))+90;
az(j) = atan2(East, North); 
T=T+1;       
end
[X, Y, Z] = sphere(10);
figure;plot3(Resfix(:,1),Resfix(:,2),Resfix(:,3));
hold on;
surf(X*6.371*10^6, Y*6.371*10^6, Z*6.371*10^6);
grid on;
xlabel('X,м');
ylabel('Y,м');
zlabel('Z,м');
title('ECEF WGS84');
figure; plot3(ResECI(:,1),ResECI(:,2),ResECI(:,3));
hold on;
surf(X*6.371*10^6, Y*6.371*10^6, Z*6.371*10^6);
grid on;
xlabel('X,м');
ylabel('Y,м');
zlabel('Z,м');
title('Инерциальная СК');
s = 1;
for y = 1:length(el);
if el(y) <= 90;
    Cel(s) = el(y);
    Caz(s) = az(y);
    s = s+1;
end
end
figure;
polarplot(2*pi-Caz, Cel); 
grid on;                         
title('Полученный SKYVIEW');